<%- include('../_lib') %>
<% title = "Cafe(chain store) Location Map in Japan" %>
<% dependsOn(title, ["d3.v3","d3-queue","leaflet"]); %>

<% description = "Cafe(chain store) Location Map in Japan" %>
<% keywords = "cafe,chain,map,location,Japan" %>
<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.1.15/leaflet-providers.min.js"></script>-->

<h1><%= title %></h1>

<div id="map" style="width: 100%; height: 900px"></div>
<link rel="stylesheet" href="https://openlayers.org/en/v4.0.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v4.0.1/build/ol.js" type="text/javascript"></script>
<script>
    $(function () {

        var styles = [];
        var features = [];

        var data = [{
            markerClass: "blue",
            code: "water",
            lat: 45, // no really, but you get the idea
            lng: 137
        }];

        $.each(data, function (i, item) {

            // Check style cache for already created style
            if (!styles[item.markerClass]) {
                // In your case you will want to use  image : new ol.style.Icon(({
                // but this is the example that I have on hand..
                styles[item.markerClass] = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 5,
                        stroke: new ol.style.Stroke({
                            color: '#000'
                        }),
                        fill: new ol.style.Fill({
                            color: item.markerClass // attribute colour
                        })
                    }),
                    text: new ol.style.Text({
                        text: item.code, // attribute code
                        fill: new ol.style.Fill({
                            color: "#000" // black text // TODO: Unless circle is dark, then white..
                        })
                    })
                });
            }

            // Create the feature
            var marker = new ol.Feature({
                content: item,
                mapid: i,
                geometry: new ol.geom.Point([item.lng, item.lat])
            });

            // Set style created earlier
            marker.setStyle(styles[item.markerClass]);

            features.push(marker);

        });
        
        var layer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGl0b2t1biIsImEiOiJjaXVqYnd0NXUwMGRwMm9tc3RvcGZ1ZDZ5In0.Q4wyiiGDLH_lTi3zzFcAtA'
            })
        });

// Assuming your layer / source is already map bound
//        var source = layer.getSource();
//        source.addFeatures(features);

        var map = new ol.Map({
            layers: [layer],
            target: 'map',
            view: new ol.View({
                center: ol.proj.transform([138, 37.8], 'EPSG:4326', 'EPSG:3857'),
                zoom: 6
            })
        });

        d3.queue()
                .defer(d3.csv, "data/starbucks.csv")
                .defer(d3.csv, "data/komeda.csv")
                .await(function(error, data, data2) {
                    if (error) {
                        console.error('Oh dear, something went wrong: ' + error);
                        return;
                    }
                    var features = data.map(function(d){
                        return new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([parseFloat(d.lng), parseFloat(d.lat)])),
                            name: 'Vienna',
                        })
                    });
                    console.log(features);
                    var markers = new ol.layer.Vector({
                        source: new ol.source.Vector({
                            features: features
                        }),
                        style: new ol.style.Style({
//                image: new ol.style.Icon({
//                    src: '//openlayers.org/en/v3.12.1/examples/data/icon.png',
//                    anchor: [0.5, 1]
//                })
                            image: new ol.style.Circle({
                                radius: 1,
                                stroke: new ol.style.Stroke({
                                    color: '#000'
                                }),
                                fill: new ol.style.Fill({
                                    color: "red"
                                })
                            }),
                        })
                    });
                    map.addLayer(markers);

                });

        
    });
</script>